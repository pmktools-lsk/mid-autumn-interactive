<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>看故事學英語｜互動版（單檔部署）</title>
<meta name="description" content="逐句跳播、雙語字幕、單字提示、小測驗。">
<style>
  :root{--bg:#0f172a;--panel:#111827;--muted:#9ca3af;--accent:#22d3ee;--accent2:#a78bfa;--danger:#ef4444;}
  html,body{height:100%;margin:0;background:#0b1220;color:#e5e7eb;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif}
  .app{display:grid;grid-template-columns:1.15fr 1fr;gap:14px;max-width:1280px;margin:0 auto;padding:14px;height:100vh;box-sizing:border-box}
  @media (max-width: 900px){.app{grid-template-columns:1fr;grid-auto-rows:minmax(0,1fr)}}
  .left,.right{background:#111827;border-radius:14px;display:flex;flex-direction:column;min-height:0}
  .left header,.right header{padding:10px 14px;border-bottom:1px solid rgba(255,255,255,.06);display:flex;align-items:center;gap:10px}
  .left header h1,.right header h2{margin:0;font-size:16px;font-weight:600}
  .player{position:relative;display:flex;flex-direction:column;gap:8px;padding:14px;height:100%;box-sizing:border-box}
  video{width:100%;max-height:65vh;border-radius:10px;background:#000}
  .controls{display:flex;flex-wrap:wrap;gap:8px}
  .btn{background:#1f2937;border:1px solid rgba(255,255,255,.1);padding:8px 10px;border-radius:10px;color:#e5e7eb;cursor:pointer}
  .btn:hover{border-color:rgba(255,255,255,.25)}
  .btn[aria-pressed="true"]{outline:2px solid var(--accent)}
  .speed{margin-left:auto;display:flex;align-items:center;gap:6px}
  .bar{height:4px;background:#111a36;border-radius:999px;overflow:hidden}
  .bar > span{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--accent),var(--accent2))}
  .banner{display:none;margin:-4px 14px 8px;padding:10px 12px;border:1px solid rgba(239,68,68,.4);background:rgba(239,68,68,.12);color:#fecaca;border-radius:10px}

  .right main{display:grid;grid-template-rows:auto auto 1fr;gap:10px;padding:14px;overflow:hidden}
  .tools{display:flex;gap:8px}
  .now{background:#0b1022;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:12px}
  .now .en{font-size:20px;font-weight:700}
  .chip{background:#1f2541;border:1px solid rgba(255,255,255,.08);padding:6px 10px;border-radius:999px;font-size:12px;margin-right:6px}
  .hidden{display:none!important}

  .list{overflow:auto;border:1px solid rgba(255,255,255,.06);border-radius:12px}
  .row{display:grid;grid-template-columns:48px 74px 1fr;gap:10px;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.06);cursor:pointer}
  .row:hover{background:#12193a}
  .row.active{background:linear-gradient(90deg, rgba(34,211,238,.18), rgba(167,139,250,.12));}
  .idx{color:#9ca3af;text-align:right}
  .time{color:#9ca3af;font-variant-numeric:tabular-nums}
  .enline{font-weight:700;line-height:1.25}
  .zhline{opacity:.85}
  .compact .row{padding:6px 10px}
  .compact .enline{line-height:1.1}
</style>
</head>
<body>
  <div class="app">
    <section class="left">
      <header>
        <h1>故事影片</h1>
        <input type="file" id="fileVideo" accept="video/*" class="btn" />
        <span class="muted">未自動載入時請按「選擇檔案」→ 選取 (story.mov / story.mp4)。</span>
      </header>
      <div id="errorBanner" class="banner"></div>
      <div class="player">
        <video id="vid" controls crossorigin="anonymous"></video>
        <div class="bar"><span id="prog"></span></div>
        <div class="controls">
          <button class="btn" id="prev">⏮ 上一句</button>
          <button class="btn" id="toggle">▶︎/⏸ 播放</button>
          <button class="btn" id="next">⏭ 下一句</button>
          <button class="btn" id="replay">🔁 重複本句</button>
          <button class="btn" id="autoPause" aria-pressed="false">🧩 逐句自動暫停</button>
          <button class="btn" id="wholeLoop" aria-pressed="false">🔂 整段循環</button>
          <button class="btn" id="abOnClick" aria-pressed="true">🅰️🅱️ 點句即循環</button>
          <button class="btn" id="clearLoop">⏹ 取消循環</button>
          <label class="speed">速度
            <input type="range" min="0.5" max="1.25" step="0.05" value="1" id="rate" />
            <span id="rateVal">1.00×</span>
          </label>
        </div>
      </div>
    </section>

    <section class="right">
      <header>
        <h2>字幕對照 / 小測驗</h2>
        <div class="tools">
          <button class="btn" id="tabSub" aria-pressed="true">📜 字幕列表</button>
          <button class="btn" id="tabQuiz" aria-pressed="false">✍️ 小測驗</button>
          <button class="btn" id="toggleCompact" aria-pressed="false">緊湊模式</button>
        </div>
      </header>
      <main id="mainRight">
        <div id="now" class="now">
          <div class="en" id="nowEn">—</div>
          <div class="zh" id="nowZh">—</div>
          <div id="nowVocab"></div>
        </div>

        <div id="quizBox" class="hidden">
          <div id="quizQ"></div>
          <div id="quizChoices" style="margin:8px 0;"></div>
          <input id="quizInput" class="hidden" placeholder="Type your answer" />
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn" id="quizCheck">檢查</button>
            <button class="btn" id="quizNext">下一題</button>
            <span id="quizMsg" class="muted"></span>
          </div>
        </div>

        <div id="list" class="list"></div>
      </main>
    </section>
  </div>

<script>
(function(){
  // ====== 1) 內建字幕稿（完整 22 句） ======
  const CUES = [
    {start:0.0,end:4.5,en:"The Mid-Autumn Festival falls on the fifteenth day of the eighth month in the Chinese lunar calendar.",zh:"中秋節在農曆八月十五這一天。",vocab:[{w:"lunar calendar",m:"農曆"}]},
    {start:4.8,end:9.3,en:"It is a time to admire the big, round moon.",zh:"這是抬頭賞圓月的時刻。",vocab:[{w:"admire",m:"欣賞"},{w:"moon",m:"月亮"}]},
    {start:9.6,end:14.1,en:"This has been a special day in China for a very long time.",zh:"在中國，這是一個流傳已久的特別節日。"},
    {start:14.4,end:18.9,en:"Long ago, there were ten suns in the sky.",zh:"很久以前，天空中曾經同時出現十個太陽。"},
    {start:19.2,end:23.7,en:"It was unbearably hot, and people suffered.",zh:"天氣炎熱難耐，人們備受煎熬。"},
    {start:24.0,end:28.5,en:"A brave archer named Hou Yi helped them.",zh:"一位勇敢的神射手后羿出手相救。",vocab:[{w:"archer",m:"弓箭手"}]},
    {start:28.8,end:33.3,en:"He climbed a tall mountain and shot down nine suns with his strong bow.",zh:"他登上高山，拉開強弓，射下了九個太陽。",vocab:[{w:"bow",m:"弓"}]},
    {start:33.6,end:38.1,en:"Everyone loved Hou Yi for saving them.",zh:"人們感激后羿的拯救。"},
    {start:38.4,end:42.9,en:"Hou Yi had a kind and beautiful wife named Chang’e, and they were very happy.",zh:"后羿的妻子名叫嫦娥，善良美麗，夫妻倆幸福美滿。"},
    {start:43.2,end:47.7,en:"One day, Hou Yi met the Queen Mother of the West, who gave him a special elixir.",zh:"有一天，后羿遇見西王母，對方贈予他一顆仙丹。",vocab:[{w:"elixir",m:"仙丹"}]},
    {start:48.0,end:52.5,en:"This elixir could grant immortality.",zh:"這顆仙丹能使人長生不死。",vocab:[{w:"immortality",m:"長生不死"}]},
    {start:52.8,end:57.3,en:"Because Hou Yi loved his wife, he did not take it and gave it to Chang’e to keep safe.",zh:"后羿因為愛妻便沒有服下，把仙丹交給嫦娥保管。"},
    {start:57.6,end:62.1,en:"A wicked man named Peng Meng learned about the elixir and wanted it for himself.",zh:"壞人逢蒙得知此事，企圖奪取仙丹。"},
    {start:62.4,end:66.9,en:"When Hou Yi was away, Peng Meng came to their home and threatened Chang’e.",zh:"趁后羿外出時，逢蒙闖入家中威逼嫦娥。"},
    {start:67.2,end:71.7,en:"Knowing she could not fight him, Chang’e quickly swallowed the elixir.",zh:"嫦娥自知無力抵抗，情急之下吞下仙丹。"},
    {start:72.0,end:76.5,en:"At once, she felt light and floated up into the sky until she reached the moon.",zh:"她立刻覺得身體變得輕盈，冉冉升空，最後來到月宮。"},
    {start:76.8,end:81.3,en:"When Hou Yi learned what had happened, he was heartbroken.",zh:"后羿得知此事後，悲痛不已。"},
    {start:81.6,end:86.1,en:"He set out Chang’e’s favorite foods to share with her from afar.",zh:"他擺上嫦娥愛吃的食物，遙祭相思。"},
    {start:86.4,end:90.9,en:"The villagers also offered food and prayed to Chang’e for blessings.",zh:"村民們也供上佳餚，向嫦娥祈求庇佑。",vocab:[{w:"pray",m:"祈禱"},{w:"blessings",m:"庇佑"}]},
    {start:91.2,end:95.7,en:"Today, people celebrate the Mid-Autumn Festival by moon-gazing and eating mooncakes.",zh:"如今，人們以賞月、吃月餅來慶祝中秋。",vocab:[{w:"mooncake",m:"月餅"}]},
    {start:96.0,end:100.5,en:"The festival is a time for families to be together and share happiness.",zh:"這是一個闔家團圓、共享歡樂的節日。"}
  ].sort((a,b)=>a.start-b.start);

  // ====== 2) 小測驗題庫 ======
  const QUIZ = [
    {type:"mcq",q:"What day does the Mid-Autumn Festival fall on in the lunar calendar?",choices:["The 15th day of the 8th month","The 1st day of the 1st month","The last day of the year","The 10th day of the 10th month"],a:0,ex:"It falls on the 15th day of the 8th lunar month."},
    {type:"mcq",q:"Who shot down nine suns?",choices:["Chang’e","Hou Yi","Peng Meng","The Queen Mother of the West"],a:1,ex:"Hou Yi climbed a mountain and shot down nine suns."},
    {type:"mcq",q:"What did the Queen Mother of the West give to Hou Yi?",choices:["A golden bow","An elixir","A mooncake","A shield"],a:1,ex:"She gave him a special elixir that could grant immortality."},
    {type:"mcq",q:"Why did Chang’e swallow the elixir?",choices:["She was hungry","She wanted to be a goddess","She could not fight Peng Meng","She lost it"],a:2,ex:"She swallowed it because she could not fight Peng Meng."},
    {type:"cloze",q:"People celebrate by moon-gazing and eating ________.",a:"mooncakes",ex:"They celebrate by moon-gazing and eating mooncakes."},
    {type:"tf",q:"True or False: The elixir could grant immortality.",a:true,ex:"True—The elixir granted immortality."}
  ];

  // ====== 3) 播放器 & 互動 ======
  const vid = document.getElementById('vid');
  const prog = document.getElementById('prog');
  const fileVideo = document.getElementById('fileVideo');
  const banner = document.getElementById('errorBanner');
  const prevBtn = document.getElementById('prev');
  const nextBtn = document.getElementById('next');
  const toggleBtn = document.getElementById('toggle');
  const replayBtn = document.getElementById('replay');
  const autoPauseBtn = document.getElementById('autoPause');
  const rate = document.getElementById('rate');
  const rateVal = document.getElementById('rateVal');
  const wholeLoopBtn = document.getElementById('wholeLoop');
  const abOnClickBtn = document.getElementById('abOnClick');
  const clearLoopBtn = document.getElementById('clearLoop');
  const tabSub = document.getElementById('tabSub');
  const tabQuiz = document.getElementById('tabQuiz');
  const toggleCompact = document.getElementById('toggleCompact');
  const list = document.getElementById('list');
  const nowEn = document.getElementById('nowEn');
  const nowZh = document.getElementById('nowZh');
  const nowVocab = document.getElementById('nowVocab');
  const nowBox = document.getElementById('now');
  const quizBox = document.getElementById('quizBox');
  const quizQ = document.getElementById('quizQ');
  const quizChoices = document.getElementById('quizChoices');
  const quizInput = document.getElementById('quizInput');
  const quizMsg = document.getElementById('quizMsg');
  const mainRight = document.getElementById('mainRight');

  let active=-1, autoPause=false, looping=false, wholeLoop=false, abOnClickEnabled=true, abIndex=-1;
  let compact=false, qIndex=0;

  function showBanner(){
    banner.style.display='block';
    banner.innerHTML='🚩 <b>未自動載入影片</b><br>請把影片放在此頁面同層，檔名 <code>story.mov</code> 或 <code>story.mp4</code>。<br>或按<b>「選擇檔案」</b> → 從你的電腦挑選影片。';
  }

  // 先嘗試自動載入 story.mov / story.mp4（含大小寫）
  const candidates=["story.mov","story.MOV","Story.mov","STORY.MOV","story.mp4","story.MP4","Story.mp4","STORY.MP4"];
  let tried=0;
  (function tryNext(){
    if(tried>=candidates.length){ showBanner(); return; }
    const src=candidates[tried++]; vid.src=src;
    const ok=()=>{ banner.style.display='none'; cleanup(); };
    const bad=()=>{ cleanup(); tryNext(); };
    const cleanup=()=>{ vid.removeEventListener('loadedmetadata', ok); vid.removeEventListener('error', bad); };
    vid.addEventListener('loadedmetadata', ok, {once:true});
    vid.addEventListener('error', bad, {once:true});
  })();

  // 手動選檔
  fileVideo.addEventListener('change', e=>{
    const f=e.target.files?.[0]; if(!f) return;
    banner.style.display='none';
    vid.src=URL.createObjectURL(f); vid.load();
  });

  function toTime(t){ const m=String(Math.floor(t/60)).padStart(2,'0'); const s=String(Math.floor(t%60)).padStart(2,'0'); return m+':'+s; }

  // 渲染字幕列表
  function renderList(){
    list.innerHTML = CUES.map((c,i)=>`
      <div class="row" data-i="${i}">
        <div class="idx">${i+1}</div>
        <div class="time">${toTime(c.start)}</div>
        <div>
          <div class="enline">${c.en}</div>
          <div class="zhline">${c.zh}</div>
        </div>
      </div>`).join('');
    list.querySelectorAll('.row').forEach(el=>{
      el.addEventListener('click',()=>{
        const i=+el.dataset.i; goCue(i,true);
        if(abOnClickEnabled){ abIndex=i; looping=true; replayBtn.setAttribute('aria-pressed','true');}
      });
    });
  }
  renderList();

  // 即時區塊
  function updateNow(i){
    const c=CUES[i]; if(!c) return;
    nowEn.textContent=c.en; nowZh.textContent=c.zh;
    nowVocab.innerHTML=(c.vocab||[]).map(v=>`<span class="chip"><b>${v.w}</b> — ${v.m}</span>`).join('');
  }

  function goCue(i, play=false){
    i=Math.max(0,Math.min(CUES.length-1,i));
    active=i; updateNow(i);
    vid.currentTime=CUES[i].start+0.02; if(play) vid.play();
  }

  function setActiveRow(i){
    const prev = list.querySelector('.row.active'); if(prev) prev.classList.remove('active');
    const now = list.querySelector(`.row[data-i="${i}"]`);
    if(now){ now.classList.add('active'); now.scrollIntoView({block:'center', behavior:'smooth'}); }
  }

  vid.addEventListener('timeupdate',()=>{
    const t=vid.currentTime;
    const i=CUES.findIndex(c=>t>=c.start&&t<c.end);
    if(i!==-1 && i!==active){ active=i; updateNow(i); setActiveRow(i); }
    if(vid.duration) prog.style.width=`${(t/vid.duration)*100}%`;
    if(autoPause&&active!==-1&&t>=CUES[active].end) vid.pause();
    if(looping&&active!==-1&&t>=CUES[active].end){
      const idx=(abIndex>=0?abIndex:active); vid.currentTime=CUES[idx].start+0.02;
    }
    const lastEnd=CUES[CUES.length-1].end;
    if(wholeLoop&&t>=lastEnd){ active=0; updateNow(0); setActiveRow(0); vid.currentTime=CUES[0].start+0.02; if(vid.paused) vid.play(); }
  });

  // 控制列
  prevBtn.onclick=()=>goCue((active===-1?0:active-1),true);
  nextBtn.onclick=()=>goCue((active===-1?0:active+1),true);
  replayBtn.onclick=()=>{ if(active===-1)return; looping=!looping; abIndex=(looping?active:-1); replayBtn.setAttribute('aria-pressed',String(looping)); };
  autoPauseBtn.onclick=()=>{ autoPause=!autoPause; autoPauseBtn.setAttribute('aria-pressed',String(autoPause)); };
  toggleBtn.onclick=()=> vid.paused?vid.play():vid.pause();
  rate.oninput=()=>{ vid.playbackRate=+rate.value; rateVal.textContent=`${(+rate.value).toFixed(2)}×`; };
  wholeLoopBtn.onclick=()=>{ wholeLoop=!wholeLoop; wholeLoopBtn.setAttribute('aria-pressed',String(wholeLoop)); };
  abOnClickBtn.onclick=()=>{ abOnClickEnabled=!abOnClickEnabled; abOnClickBtn.setAttribute('aria-pressed',String(abOnClickEnabled)); };
  clearLoopBtn.onclick=()=>{ looping=false; abIndex=-1; replayBtn.setAttribute('aria-pressed','false'); };

  // 分頁
  tabSub.onclick=()=>{ tabSub.setAttribute('aria-pressed','true'); tabQuiz.setAttribute('aria-pressed','false'); list.classList.remove('hidden'); quizBox.classList.add('hidden'); nowBox.classList.remove('hidden'); };
  tabQuiz.onclick=()=>{ tabSub.setAttribute('aria-pressed','false'); tabQuiz.setAttribute('aria-pressed','true'); list.classList.add('hidden'); quizBox.classList.remove('hidden'); nowBox.classList.add('hidden'); renderQuiz(); };

  // 緊湊模式
  toggleCompact.onclick=()=>{ 
    compact=!compact; toggleCompact.setAttribute('aria-pressed', String(compact));
    mainRight.classList.toggle('compact', compact);
  };

  // 小測驗
  function renderQuiz(){
    const q=QUIZ[qIndex]; quizMsg.textContent='';
    quizChoices.innerHTML=''; quizInput.classList.add('hidden');
    if(q.type==='mcq'){
      quizQ.textContent = `Q${qIndex+1}. ${q.q}`;
      q.choices.forEach((c,idx)=>{
        const b=document.createElement('button'); b.className='btn'; b.textContent=c; b.dataset.idx=idx;
        b.onclick=()=>{ [...quizChoices.children].forEach(x=>x.classList.remove('sel')); b.classList.add('sel'); b.dataset.sel='1'; };
        quizChoices.appendChild(b);
      });
    } else if(q.type==='cloze'){
      quizQ.textContent = `Q${qIndex+1}. ${q.q}`;
      quizInput.classList.remove('hidden'); quizInput.value=''; quizInput.focus();
    } else if(q.type==='tf'){
      quizQ.textContent = `Q${qIndex+1}. ${q.q}`;
      ['True','False'].forEach((label,idx)=>{
        const b=document.createElement('button'); b.className='btn'; b.textContent=label; b.dataset.val=String(idx===0);
        b.onclick=()=>{ [...quizChoices.children].forEach(x=>x.classList.remove('sel')); b.classList.add('sel'); };
        quizChoices.appendChild(b);
      });
    }
  }
  document.getElementById('quizCheck').onclick=()=>{
    const q=QUIZ[qIndex];
    let correct=false;
    if(q.type==='mcq'){
      const picked=[...quizChoices.children].find(x=>x.classList.contains('sel'));
      if(picked){ correct = Number(picked.dataset.idx)===q.a; }
    } else if(q.type==='cloze'){
      const val=(document.getElementById('quizInput').value||'').trim().toLowerCase();
      correct = val===String(q.a).toLowerCase();
    } else if(q.type==='tf'){
      const picked=[...quizChoices.children].find(x=>x.classList.contains('sel'));
      if(picked){ correct = (picked.dataset.val === String(q.a)); }
    }
    quizMsg.textContent = correct ? '✔️ 正確！ ' + (q.ex||'') : '✖ 再想想～ ' + (q.ex?('提示：'+q.ex):'');
  };
  document.getElementById('quizNext').onclick=()=>{ qIndex=(qIndex+1)%QUIZ.length; renderQuiz(); };

})();
</script>
</body>
</html>
